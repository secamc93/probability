services:

  font-central:
    platform: linux/arm64
    image: public.ecr.aws/c1l9h7c9/probability:frontend-latest
    container_name: frontend_prod
    ports:
      - "8080:80"
    env_file:
    - .env 
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:80/"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - app-network
    depends_on:
      - back-central
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    deploy:
      resources:
        limits:
          cpus: "0.50"
          memory: 256M
        reservations:
          cpus: "0.25"
          memory: 128M

  back-central:
    platform: linux/arm64
    image: public.ecr.aws/c1l9h7c9/probability:backend-latest
    container_name: central_reserve_prod
    ports:
      - "3050:3050"
    environment:
      # Nota: DB_HOST debe apuntar a tu base de datos PostgreSQL externa
      # Si usas una BD externa, cambia "postgres" por el hostname real
      DB_HOST:             "${DB_HOST:-postgres}"
      DB_PORT:             "5432"
      DB_NAME:             "${DB_NAME}"
      DB_USER:             "${DB_USER}"
      DB_PASS:             "${DB_PASSWORD}"
      DB_LOG_LEVEL:        "${DB_LOG_LEVEL}"
      PGSSLMODE:           "${DB_SSLMODE}"
      APP_ENV:             "${APP_ENV}"
      HTTP_PORT:           "3050"
      LOG_LEVEL:           "${LOG_LEVEL}"
      JWT_SECRET:          "${JWT_SECRET}"
      URL_BASE_SWAGGER:    "${URL_BASE_SWAGGER}"
      SMTP_HOST:           "${SMTP_HOST}"
      SMTP_PORT:           "${SMTP_PORT}"
      SMTP_USER:           "${SMTP_USER}"
      SMTP_PASS:           "${SMTP_PASS}"
      FROM_EMAIL:          "${FROM_EMAIL:-}"
      SMTP_USE_STARTTLS:   "${SMTP_USE_STARTTLS}"
      SMTP_USE_TLS:        "${SMTP_USE_TLS}"
      # S3 y media
      S3_BUCKET:           "${S3_BUCKET}"
      S3_REGION:           "${S3_REGION}"
      S3_KEY:              "${S3_KEY}"
      S3_SECRET:           "${S3_SECRET}"
      URL_BASE_DOMAIN_S3:  "${URL_BASE_DOMAIN_S3}"
      # WhatsApp
      WHATSAPP_URL:        "${WHATSAPP_URL}"
      WHATSAPP_TOKEN:      "${WHATSAPP_TOKEN}"
      WHATSAPP_PHONE_NUMBER_ID: "${WHATSAPP_PHONE_NUMBER_ID}"
      # Encryption
      ENCRYPTION_KEY:      "${ENCRYPTION_KEY}"
      # Redis (usar nombre del servicio en la red Docker)
      REDIS_HOST:         "redis"
      REDIS_PORT:         "6379"
      REDIS_PASSWORD:     "${REDIS_PASSWORD:-}"
      REDIS_ORDER_EVENTS_CHANNEL: "${REDIS_ORDER_EVENTS_CHANNEL:-probability:orders:events}"
      # RabbitMQ (usar nombre del servicio en la red Docker)
      RABBITMQ_HOST:      "rabbitmq"
      RABBITMQ_PORT:      "5672"
      RABBITMQ_USER:      "${RABBITMQ_USER:-admin}"
      RABBITMQ_PASS:      "${RABBITMQ_PASS:-admin}"
      RABBITMQ_VHOST:     "${RABBITMQ_VHOST:-/}"
    restart: unless-stopped
  
    networks:
      - app-network
    depends_on:
      redis:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    logging:
      driver: "json-file"
      options:
        max-size: "20m"
        max-file: "5"
    deploy:
      resources:
        limits:
          cpus: "1.00"
          memory: 512M
        reservations:
          cpus: "0.50"
          memory: 256M


  # Redis Cache
  redis:
    image: redis:7-alpine
    container_name: redis_prod
    ports:
      - "6379:6379"
    command: redis-server --appendonly yes
    volumes:
      - redis_data:/data
    networks:
      - app-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped



  # RabbitMQ Message Queue
  rabbitmq:
    image: rabbitmq:3-management-alpine
    container_name: rabbitmq_prod
    ports:
      - "5672:5672"   # AMQP port
      - "15672:15672" # Management UI
    environment:
      RABBITMQ_DEFAULT_USER: admin
      RABBITMQ_DEFAULT_PASS: admin
      RABBITMQ_DEFAULT_VHOST: /
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq
    networks:
      - app-network
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "ping"]
      interval: 30s
      timeout: 10s
      retries: 5
    restart: unless-stopped

  nginx:
    image: public.ecr.aws/c1l9h7c9/probability:nginx-latest
    container_name: nginx_prod
    ports:
      - "80:80"
      - "443:443"
    environment:
      DOMAIN: "${DOMAIN}"
      SSL_CERT_PATH: "${SSL_CERT_PATH}"
      SSL_KEY_PATH: "${SSL_KEY_PATH}"
    volumes:
      - /etc/letsencrypt:/etc/letsencrypt:ro
    depends_on:
      - font-central
    networks:
      - app-network
    restart: unless-stopped

networks:
  app-network:
    driver: bridge

volumes:
  redis_data:
    driver: local
  rabbitmq_data:
    driver: local
